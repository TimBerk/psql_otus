# Виды индексов. Работа с индексами и оптимизация запросов 

<p align="left">
    <a href="https://www.docker.com/" target="blank">
        <img src="https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white" />
    </a>
    <a href="https://www.postgresql.org/" target="blank">
        <img src="https://img.shields.io/badge/postgres-%23316192.svg?style=for-the-badge&logo=postgresql&logoColor=white"/>
    </a>
</p>

В качестве рабочего окружения используется PostgreSQL 16 версии установленный в Docker.

Дополнительно устанавливается решение [asciinema](https://asciinema.org/) - для составления интерактивного отчета.

Для работы с индексами используется демонстрационная база данных «Авиаперевозки».

Каждый этап имеет следующую структуру:

* Номера затрагиваемых задач
* Краткий отчет о том, что было сделано
* Пример выполнения команд

## Оглавление

- [Задание](#задание)
- [Практика](#практика)
- [Используемые источники](#используемые-источники)

### Задание

1. Создать индекс к какой-либо из таблиц вашей БД
2. Прислать текстом результат команды EXPLAIN, в которой используется данный индекс
3. Реализовать индекс для полнотекстового поиска
4. Реализовать индекс на часть таблицы или индекс на поле с функцией
5. Создать индекс на несколько полей
6. Написать комментарии к каждому из индексов
7. Описать что и как делали и с какими проблемами столкнулись

### Практика

<details>
  <summary> ✔️ Создание индекса</summary>

**Затрагиваемые задачи**: 1-2

**Выполнение задания**:

* В данном задании будет рассматриваться фильтрация по статусу записи. Для этой цели будет использоваться таблица `flights`.
* Сначала проверяется план запросов без индекса.
* После создается индекс `idx_flights_status` и заново проверяются планы запросов.
* Исходя из полученных данных видно, что использование индекса уменьшает стоимость выполнения запроса, т.к. `B-tree` индексы являются стандартным выбором для многих сценариев, где требуется быстрый доступ к данным по ключевым полям.

[![asciicast](https://asciinema.org/a/zWKMuJh8y6ROfwlArM3l5UGjg.svg)](https://asciinema.org/a/zWKMuJh8y6ROfwlArM3l5UGjg)

| Запрос | cost/cost index  | cost index      | rows  | width |
|--------|------------------|-----------------|-------|-------|
| 1      | 1816.96..1817.02 | 0.29..1663.59   | 6     | 16    |
| 2      | 0.00..1652.80    | 174.73..1197.75 | 15282 | 63    |

</details>

<details>
  <summary> ✔️ Реализовать индекс для полнотекстового поиска</summary>

**Затрагиваемые задачи**: 3

**Выполнение задания**:

* В данном задании будет рассматриваться полнотекстовый поиск для имени пассажира.
* Дополнительно используется решение `pg_trgm`.
* Для поля `passenger_name` таблицы `bookings.tickets` в рамках тестирования был создан индекс разных типов: btree, gin, gist.
* Результаты тестирования представлены в таблице.

[![asciicast](https://asciinema.org/a/D7qcCEAQ7DH2Sml7SdgDI8Fen.svg)](https://asciinema.org/a/D7qcCEAQ7DH2Sml7SdgDI8Fen)

| index   | cost              | rows   | width | Planning Time | Execution Time |
|---------|-------------------|--------|-------|---------------|----------------|
| without | 1000.00..19245.48 | 74     | 101   | 0.913 ms      | 29.761 ms      |
| pg_trgm | 0.00..24283.39    | 829071 | 108   | 0.033 ms      | 2655.387 ms    |
| btree   | 5.00..285.74      | 74     | 104   | 0.385 ms      | 2.772 ms       |
| gin     | 30.09..117.98     | 21     | 136   | 1.058 ms      | 2.782 ms       |
| gist    | 4.98..291.16      | 74     | 140   | 0.780 ms      | 60.832 ms      |

**Выводы:**
* Полнотекстовый поиск **без индекса** один из самых дорогих способов.
* При отсутствии индекса использование решения `pg_trgm` может улучшить возможности поиска и анализа сходства строк.
* **B-деревья** могут использоваться для индексации отдельных слов или терминов, чтобы ускорить поиск.
* **GIN** индексы особенно эффективны для случаев, когда нужно быстро находить документы, содержащие одно или несколько заданных слов или терминов.
* **GIST** индексы предоставляют гибкий и эффективный способ организации данных, что делает их полезными для широкого спектра задач, включая полнотекстовый поиск.

</details>

<details>
  <summary> ✔️ Реализовать индекс на часть таблицы или индекс на поле с функцией</summary>

**Затрагиваемые задачи**: 4

**Выполнение задания**:

* В данном задании будет рассматриваться индекс для фактического времени вылета. Для этой цели будет использоваться таблица `flights`.
* Сначала проверяется план запросов без индекса.
* После создается индекс `idx_flights_departure` и заново проверяется план запрос.
* Создание частичного индекса в PostgreSQL позволяет улучшить производительность запросов, которые фильтруют данные по определенному условию, и сэкономить место на диске, так как индекс создается только для части таблицы. Частичные индексы могут быть особенно полезны, когда таблица содержит много строк, но запросы часто обращаются только к небольшой их части.

[![asciicast](https://asciinema.org/a/PE5WZUFPBnL3BMnkTude3w7Dy.svg)](https://asciinema.org/a/PE5WZUFPBnL3BMnkTude3w7Dy)

| index   | cost          |
|---------|---------------|
| without | 0.00..1652.80 |
| with    | 4.31..12.04   |

</details>

<details>
  <summary> ✔️ Создать индекс на несколько полей</summary>

**Затрагиваемые задачи**: 5

**Выполнение задания**:

* В данном задании будет рассматриваться фильтрация по дате отправления и дате прилета из таблицы `flights`.
* Сначала проверяется план запросов без индекса.
* После создается индекс `idx_flights_time_range` и заново проверяются планы запросов.
* Исходя из полученных данных видно, что использование индекса для нескольких полей в PostgreSQL работает эффективно только при включении всех полей, указанные в индексе. Если запрос фильтрует данные только по одному полю, индекс может не использоваться. Чтобы обеспечить использование индекса в таких случаях, можно создать отдельные индексы для каждого поля.

[![asciicast](https://asciinema.org/a/mDEfzhW8JYpTSl2TDLmiAAWEg.svg)](https://asciinema.org/a/mDEfzhW8JYpTSl2TDLmiAAWEg)

|          | cost          | cost with index |
|----------|---------------|-----------------|
| 2 fields | 0.00..1816.96 | 419.77..1496.67 |
| 1 field  | 0.00..1652.80 | 0.00..1652.80   |

</details>

### Используемые источники

* [8.11. Text Search Types](https://www.postgresql.org/docs/16/datatype-textsearch.html)
* [K.4. Объекты схемы](https://postgrespro.ru/docs/postgrespro/16/demodb-schema-objects)
* [Индексирование полнотекстовых данных в PostgreSQL с использованием модуля pg_trgm](https://habr.com/ru/companies/otus/articles/770674/)