# Работа с базами данных, пользователями и правами

<p align="left">
    <a href="https://www.docker.com/" target="blank">
        <img src="https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white" />
    </a>
    <a href="https://www.postgresql.org/" target="blank">
        <img src="https://img.shields.io/badge/postgres-%23316192.svg?style=for-the-badge&logo=postgresql&logoColor=white"/>
    </a>
</p>

В качестве рабочего окружения используется Docker-контейнер для PostgreSQL 14 версии.

Дополнительно устанавливается решение [asciinema](https://asciinema.org/) - для составления интерактивного отчета.

Каждый этап имеет следующую структуру:
 * Номера затрагиваемых задач
 * Краткий отчет о том, что было сделано
 * Пример выполнения команд

## Оглавление
- [Подготовка](#подготовка)
- [Задание](#задание)
- [Практика](#практика)
- [Используемые источники](#используемые-источники)

### Подготовка

Используемые Make-команды:
* `run` - запуск контейнера
* `stop` - остановка контейнера
* `clear` - удаление контейнера и его volume
* `rebuild` - пересборка контейнера
* `clink` - подключение к терминалу контейнера

### Задание

1. создайте новый кластер PostgresSQL 14
2. зайдите в созданный кластер под пользователем `postgres`
3. создайте новую базу данных `testdb`
4. зайдите в созданную базу данных под пользователем `postgres`
5. создайте новую схему `testnm`
6. создайте новую таблицу `t1` с одной колонкой `c1` типа `integer`
7. вставьте строку со значением `c1=1`

8. создайте новую роль `readonly`
9. дайте новой роли право на подключение к базе данных `testdb`
10. дайте новой роли право на использование схемы `testnm`
11. дайте новой роли право на select для всех таблиц схемы `testnm`
12. создайте пользователя `testread` с паролем `test123`
13. дайте роль `readonly` пользователю `testread`
14. зайдите под пользователем `testread` в базу данных `testdb`
15. сделайте `select * from t1;`
16. получилось? (могло если вы делали сами не по шпаргалке и не упустили один существенный момент про который позже)
17. напишите что именно произошло в тексте домашнего задания
18. у вас есть идеи почему? ведь права то дали?
19. посмотрите на список таблиц
20. подсказка в шпаргалке под пунктом 20
21. а почему так получилось с таблицей (если делали сами и без шпаргалки то может у вас все нормально)

22. вернитесь в базу данных `testdb` под пользователем `postgres`
23. удалите таблицу `t1`
24. создайте ее заново, но уже с явным указанием имени схемы `testnm`
25. вставьте строку со значением `c1=1`
26. зайдите под пользователем `testread` в базу данных `testdb`
27. сделайте `select * from testnm.t1`;
28. получилось?
29. есть идеи почему? если нет - смотрите шпаргалку
30. как сделать так, чтобы такое больше не повторялось? если нет идей - смотрите шпаргалку
31. сделайте `select * from testnm.t1`;
32. получилось?
33. есть идеи почему? если нет - смотрите шпаргалку
34. сделайте `select * from testnm.t1`;
35. получилось?
36. ура!

37. теперь попробуйте выполнить команду `create table t2(c1 integer); insert into t2 values (2)`;
38. а как так? нам же никто прав на создание таблиц и insert в них под ролью `readonly`?
39. есть идеи как убрать эти права? если нет - смотрите шпаргалку
40. если вы справились сами, то расскажите что сделали и почему, если смотрели шпаргалку - объясните что сделали и почему выполнив указанные в ней команды
41. теперь попробуйте выполнить команду `create table t3(c1 integer); insert into t2 values (2)`;
42. расскажите что получилось и почему

### Практика

<details>
  <summary> ✔️ Установка и подготовка PostgreSQL</summary>

**Затрагиваемые задачи**: 1 - 7

**Выполнение задания**:

* В ходе выполнения задания, был установлен PostgreSQL 14 версии в Docker-контейнер.
* Были созданы тестовые: база данных, схема, таблица и вставлена тестовая запись.

**Подготовка PostgreSQL**:

[![asciicast](https://asciinema.org/a/RqPYnYOdrxRTXlg7cP40XXd98.svg)](https://asciinema.org/a/RqPYnYOdrxRTXlg7cP40XXd98)

</details>

<details>
  <summary> ✔️ Работа с ролью readonly</summary>

**Затрагиваемые задачи**: 8 - 21

**Выполнение задания**:

* Согласно описанию была создана роль `readonly`, которая может делать выборки в схеме `testnm` в базе `testdb`.
* Был добавлен пользователь `testread`, которому была назначена роль `readonly`.
* При попытке пользователя `testread` сделать выборку в таблице `t1` возникла ошибка доступа, так как таблица `t1` принадлежит схеме `public`.
* В качестве теста роли `readonly` был предоставлен доступ к схеме `public`. После этих действий пользователь `testread` смог сделать запрос к таблице `t1`. По окончанию теста права к схеме `public` у роли `readonly` были отозваны.

**Работа с ролями и правами доступа**:

[![asciicast](https://asciinema.org/a/xfZW3gcRnUi7Avy9Ucr6AeVOo.svg)](https://asciinema.org/a/xfZW3gcRnUi7Avy9Ucr6AeVOo)

*P.s. Для имитации выполнения запросов разными пользователями специально используется команда `psql -U <user> -d <db>`* 

</details>

<details>
  <summary> ✔️ Работа с таблицей t1</summary>

**Затрагиваемые задачи**: 22 - 36

**Выполнение задания**:

* Согласно описанию была удалена таблица `t1`, после чего она была создана в схеме `testnm`.
* Также для удобства работы обоим пользователям в путь поиска схемы была добавлена схема `testnm`.
* При выполнении запроса к таблице `t1` пользователем `testread` возникла ошибка доступа, так как ранее доступ предоставлялся только к существующим таблицам и не предполагал предоставление доступа к новым.
* Для исправления ошибки, пользователем `postgres` заново был предоставлен доступ к текущим таблицам в схеме `testnm`, а также была предусмотрена возможность работы с новыми таблицами.
* После обновления доступа, пользователь `testread` смог выполнить запрос к таблице `t1`.
* Также для проверки доступа к новой таблице, пользователем `postgres` была создана таблица `t2`. После этих действий, пользователь `testread` также смог прочитать данные из таблицы `t2`.

**Работа с таблицей t1**:

[![asciicast](https://asciinema.org/a/sG5ockB8NorsyN7UELyOud1wX.svg)](https://asciinema.org/a/sG5ockB8NorsyN7UELyOud1wX)

*P.s. Для имитации выполнения запросов разными пользователями специально используется команда `psql -U <user> -d <db>`* 

</details>

<details>
  <summary> ✔️ Работа со схемой public</summary>

**Затрагиваемые задачи**: 37 - 42

**Выполнение задания**:

*P.S. После предыдущего этапа таблица `t2` была удалена и путь к поиску схем был установлен как `public`.*

* Пользователем `testread` была создана и заполнена таблица `t2`. Данное поведение объясняется тем, что при создании пользователя ему автоматически присваивается роль `public`, которая дает возможность работать со схемой `public`.
* Из-за возможности создания и наполнения таблиц, доступ к схеме `public` в базе данных `testdb` был отозван.
* В результате изменения доступа, пользователь `testread` не смог создать новую таблицу, но при этом у него остались права на добавление данных в таблицу `t2`.
* Дополнительно у пользователя `testread` были отозваны все права для работы со схемой `public`.

**Работа со схемой public**:

[![asciicast](https://asciinema.org/a/CKjqpkxM77gtWfM8Reu6iQBb5.svg)](https://asciinema.org/a/CKjqpkxM77gtWfM8Reu6iQBb5)

</details>

### Используемые источники
* [5.8.3. Путь поиска схемы](https://postgrespro.ru/docs/postgrespro/9.6/ddl-schemas)
* [Привилегии в PostgreSQL](https://sysadminium.ru/privilegii_v_postgresql/)