# Виды и устройство репликации в PostgreSQL

<p align="left">
    <a href="https://www.docker.com/" target="blank">
        <img src="https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white" />
    </a>
    <a href="https://www.postgresql.org/" target="blank">
        <img src="https://img.shields.io/badge/postgres-%23316192.svg?style=for-the-badge&logo=postgresql&logoColor=white"/>
    </a>
</p>

В качестве рабочего окружения используется PostgreSQL 16 версии установленный в Docker.

Дополнительно устанавливается решение [ScreenToGif](https://www.screentogif.com/) - для составления интерактивного
отчета, так как работа идет с несколькими сессиями.

Каждый этап имеет следующую структуру:

* Номера затрагиваемых задач
* Краткий отчет о том, что было сделано
* Пример выполнения команд

## Оглавление

- [Задание](#задание)
- [Практика](#практика)
- [Используемые источники](#используемые-источники)

### Задание

1. На 1 ВМ создаем таблицы test для записи, test2 для запросов на чтение. 
2. Создаем публикацию таблицы test и подписываемся на публикацию таблицы test2 с ВМ №2.
3. На 2 ВМ создаем таблицы test2 для записи, test для запросов на чтение. 
4. Создаем публикацию таблицы test2 и подписываемся на публикацию таблицы test1 с ВМ №1. 
5. 3 ВМ использовать как реплику для чтения и бэкапов (подписаться на таблицы из ВМ №1 и №2 ).
6. * реализовать горячее реплицирование для высокой доступности на 4ВМ. Источником должна выступать ВМ №3. Написать с какими проблемами столкнулись.

### Практика

Используемые контейнеры:
* ВМ №1 - `master_01`
* ВМ №2 - `master_02`
* ВМ №3 - `slave_01`
* ВМ №4 - `slave_02`

<details>
  <summary> ✔️ Работа с созданием публикаций и подписок</summary>

**Затрагиваемые задачи**: 1-5

**Выполнение задания**:

* Посредствам `init.sh` настраиваются БД и реплика, после чего кластер перезапускается.
* Для удобства указываются переменные `PR_REPL` и `PR_REPL_2` для подключения к БД публикаций.
* Для пользователя реплики выдаются права на выбор данных из таблиц.
* Создаются публикации и подписки - сначала в 1 и 2 БД, потом в 3.
* В каждую таблицу вставляются тестовые записи и проверяется их наличие в БД-подписчиках.

![Работа с подписками и публикациями](./gifs/replication.gif)

</details>


<details>
  <summary> ✔️ Горячее реплицирование</summary>

**Затрагиваемые задачи**: 6

**Выполнение задания**:

* Создан дополнительный файл `docker-compose-hot.yml`, на основе которого создаются 2 мастера и 2 реплики.
* Посредствам `init_m_hot.sh` и `init_s_hot.sh` настраиваются БД и реплики, после чего кластер перезапускается.
* В контейнере реплики `slave_02` удаляется содержимое папки `/var/lib/postgresql/data` и выполняется команда:
```bash
pg_basebackup -h slave_01 -U $PR_REPL_USER -D /var/lib/postgresql/data -P -X stream -R
```
* В основном контейнере(`slave_01`) для проверки репликации выполняется запрос:
```bash
postgres=# SELECT * FROM pg_stat_replication;
 pid | usesysid | usename  | application_name | client_addr |client_port |         backend_start         |   state   | sent_lsn  | write_lsn | flush_lsn | replay_lsn | sync_priority | sync_state |          reply_time
-----+----------+----------+------------------+-------------+------------+-------------------------------+-----------+-----------+-----------+-----------+------------+---------------+------------+-------------------------------
 215 |    16385 | rep_user | walreceiver      | 172.21.0.3  |      57216 | 2024-08-13 23:24:52.614966+03 | streaming | 0/3000060 | 0/3000060 | 0/3000060 | 0/3000060  |             0 | async      | 2024-08-13 23:25:02.685712+03
(1 row)
```
   
*P.s. В выводе данных удалены пустые колонки: client_hostname, backend_xmin, write_lag, flush_lag, replay_lag*

* Проверка данных такая же как и в задании выше:
```sql
psql -U postgres -d replication -c "INSERT INTO test(content) SELECT md5(random()::text)::char(150) FROM generate_series(1, 10)"

psql -U postgres -d replication -c "SELECT count(*) FROM test"
```

Сложности при выполнении задания в основном были связаны с разобщенными примерами конфигураций для реплик и настроек для Docker-контейнеров.

</details>

### Используемые источники

* [Настройка репликации PostgreSQL в контейнерах Docker](https://www.dmosk.ru/miniinstruktions.php?mini=postgresql-replication-docker)
* [pg_basebackup](https://www.postgresql.org/docs/16/app-pgbasebackup.html)
