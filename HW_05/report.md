# Настройка autovacuum с учетом особенностей производительности

<p align="left">
    <a href="https://www.docker.com/" target="blank">
        <img src="https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white" />
    </a>
    <a href="https://yandex.cloud/ru/" target="blank">
        <img src="https://img.shields.io/badge/Ubuntu-E95420?style=for-the-badge&logo=ubuntu&logoColor=white" />
    </a>
    <a href="https://www.postgresql.org/" target="blank">
        <img src="https://img.shields.io/badge/postgres-%23316192.svg?style=for-the-badge&logo=postgresql&logoColor=white"/>
    </a>
</p>

В качестве рабочего окружения используется PostgreSQL 15 версии установленный в Yandex Cloud. Также остались настройки для Docker-контейнера.

Дополнительно устанавливается решение [asciinema](https://asciinema.org/) - для составления интерактивного отчета.

Каждый этап имеет следующую структуру:
 * Номера затрагиваемых задач
 * Краткий отчет о том, что было сделано
 * Пример выполнения команд

## Оглавление
- [Задание](#задание)
- [Практика](#практика)
- [Используемые источники](#используемые-источники)

### Задание

1. Создать инстанс ВМ с 2 ядрами и 4 Гб ОЗУ и SSD 10GB 
2. Установить на него PostgreSQL 15 с дефолтными настройками
3. Создать БД для тестов: выполнить `pgbench -i postgres`
4. Запустить `pgbench -c8 -P 6 -T 60 -U postgres postgres`
5. Применить параметры настройки PostgreSQL из прикрепленного к материалам занятия файла
6. Протестировать заново
7. Что изменилось и почему?

8. Создать таблицу с текстовым полем и заполнить случайными или сгенерированными данным в размере 1млн строк
9. Посмотреть размер файла с таблицей
10. 5 раз обновить все строчки и добавить к каждой строчке любой символ
11. Посмотреть количество мертвых строчек в таблице и когда последний раз приходил автовакуум
12. Подождать некоторое время, проверяя, пришел ли автовакуум
13. 5 раз обновить все строчки и добавить к каждой строчке любой символ
14. Посмотреть размер файла с таблицей

15. Отключить Автовакуум на конкретной таблице
16. 10 раз обновить все строчки и добавить к каждой строчке любой символ
17. Посмотреть размер файла с таблицей
18. Объясните полученный результат
19. Не забудьте включить автовакуум)

20. Задание со *: Написать анонимную процедуру, в которой в цикле 10 раз обновятся все строчки в искомой таблице. Не забыть вывести номер шага цикла.

### Практика

<details>
  <summary> ✔️ Установка, подготовка и тестирование PostgreSQL</summary>

**Затрагиваемые задачи**: 1 - 7

**Выполнение задания**:

* В ходе выполнения задания, был установлен PostgreSQL 15 в Yandex Cloud.
* Была создана база для проведения тестирования посредствам `pgbench`.
* Были запущены 2 теста производительности: 1-ый со стандартными настройками, 2-ой с предложенными.
* Параметры настроек и результаты тестов представлены в таблицах ниже.
* Дополнительно для удобства были созданы функции и процедура для обновления данных.

**Таблица параметров**

| params                       | description                                                                       |      default | with new settings |
|------------------------------|-----------------------------------------------------------------------------------|-------------:|------------------:|
| max_connections              | кол-во одновременных подключений к серверу                                        |          100 |                40 |
| shared_buffers               | объём совместно используемой памяти, выделяемой для кэширования данных            |        128MB |               1GB |
| effective_cache_size         | примерный объём файлового кэша операционной системы                               | no set (4GB) |               3GB |
| maintenance_work_mem         | память используется для выполнения операций                                       | no set(64MB) |             512MB |
| checkpoint_completion_target | целевое время для завершения процедуры контрольной точки                          |  no set(0.9) |               0.9 |
| wal_buffers                  | объём разделяемой памяти                                                          |   no set(-1) |              16MB |
| default_statistics_target    | значение ориентира статистики по умолчанию                                        |  no set(100) |               500 |
| random_page_cost             | приблизительная стоимость чтения 1 произвольной страницы с диска                  |  no set(4.0) |                 4 |
| effective_io_concurrency     | допустимое число параллельных операций ввода/вывода                               |    no set(1) |                 2 |
| work_mem                     | базовый максимальный объём памяти                                                 |  no set(4MB) |           65536kB |
| min_wal_size                 | минимальный размер, до которого старые файлы WAL перерабатываются, а не удаляются |         80MB |               4GB |
| max_wal_size                 | максимальный размер, до которого может вырастать WAL                              |          1GB |              16GB |

Исходя из новых конфигураций видно, что произошло:

    * Уменьшение количества подключений.
    * Увеличение объемов памяти и кэширования.
    * Увеличение количества параллельных операций ввода/вывода.

**Таблица сравнения запуска тестов**

| params                                    |    default | with new settings |
|-------------------------------------------|-----------:|------------------:|
| scaling factor                            |          1 |                 1 |
| query mode                                |     simple |            simple |
| number of clients                         |          8 |                 8 |
| number of threads                         |          1 |                 1 |
| maximum number of tries                   |          1 |                 1 |
| duration                                  |        60s |               60s |
| number of transactions actually processed |      21280 |             21875 |
| number of failed transactions             |          0 |                 0 |
| latency average                           |  22.553 ms |         21.941 ms |
| latency stddev                            |  21.442 ms |         24.000 ms |
| initial connection time                   | 15.053  ms |         15.189 ms |
| tps (without initial connection time)     | 354.658054 |        364.513195 |

Согласно полученным результатам видно, что применив настройки произошло:

    * Увеличение количества транзакций с `21280` до `21875` и транзакций в секунду `354.7` до `364.5`.
    * Увеличение скорости запроса с `22.553 ms` до `21.941 ms`.

**Тестирование с pgbench**:

[![asciicast](https://asciinema.org/a/qI2JL601h3DlMZWEZEnbF9DkC.svg)](https://asciinema.org/a/qI2JL601h3DlMZWEZEnbF9DkC)

**Добавление вспомогательных функций**:

[![asciicast](https://asciinema.org/a/8dE7mRba3qw7xvkx3OlPzvvJk.svg)](https://asciinema.org/a/8dE7mRba3qw7xvkx3OlPzvvJk)

</details>

<details>
  <summary> ✔️ Работа с Vacuum</summary>

**Затрагиваемые задачи**: 8 - 14

**Выполнение задания**:

* В ходе выполнения задания, была создана тестовая таблица `vac` с текстовым полем `c`.
* Изначально таблица имела размер в `42 MB`, после выполнения обновления записей, размер увеличился до `299 MB`.
* Также при первом выполнении обновления `autovacuum` отработал практически моментально.
* При 2 обновлении заметно `5000000` мертвых строк, которые через пару секунд были удалены.

**Работа с Vacuum**:

[![asciicast](https://asciinema.org/a/iBBFqSIjAISXIzgxdKI8DGGLX.svg)](https://asciinema.org/a/iBBFqSIjAISXIzgxdKI8DGGLX)

</details>

<details>
  <summary> ✔️ Работа с выключенным Vacuum</summary>

**Затрагиваемые задачи**: 15 - 19

**Выполнение задания**:

* В ходе выполнения задания, был отключен `autovacuum` для тестовой таблицы `vac`.
* Изначально таблица имела размер в `299 MB`, после выполнения обновления записей, размер увеличился до `548 MB`.
* Данное поведение объясняется тем, что при обновлении таблицы остались неактуальные версии строк. При включенном `autovacuum` данные строки могли бы переиспользоваться(что было видно на предыдущем этапе). Для сжатия таблицы можно воспользоваться командой `VACUUM FULL`.

**Работа с выключенным Vacuum**:

[![asciicast](https://asciinema.org/a/i1ZfKFTUZexshHWNRRw5CCZve.svg)](https://asciinema.org/a/i1ZfKFTUZexshHWNRRw5CCZve)

</details>

<details>
  <summary> ✔️ Задание со звездочкой</summary>

**Затрагиваемые задачи**: 20

**Выполнение задания**:

* В ходе выполнения задания, была создана процедура по заполнению данных. В параметрах процедуры указывается количество итераций и количество символов для создания новой строки.
* На протяжении всего задания процедура активно использовалась.

```sql
CREATE OR REPLACE PROCEDURE upd_data(int, int default 15) AS
$$
BEGIN
	FOR counter IN 1 .. $1 BY 1
	LOOP
		RAISE INFO 'Update data step: %', counter;
		UPDATE vac SET s = substr(md5(random()::text), 1, $2);
	END LOOP;
END
$$
  LANGUAGE 'plpgsql';
```
</details>


### Используемые источники
* [20.4. Потребление ресурсов](https://postgrespro.ru/docs/postgresql/15/runtime-config-resource)
* [20.5. Журнал предзаписи](https://postgrespro.ru/docs/postgresql/15/runtime-config-wal)
* [20.7. Планирование запросов](https://postgrespro.ru/docs/postgresql/15/runtime-config-query)
* [25.1. Регламентная очистка](https://postgrespro.ru/docs/postgresql/15/routine-vacuuming)
* [38.3. Пользовательские функции](https://postgrespro.ru/docs/postgresql/15/xfunc)
* [38.4. Пользовательские процедуры](https://postgrespro.ru/docs/postgresql/15/xproc)